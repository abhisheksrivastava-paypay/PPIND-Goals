<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPIND Engineering KPI Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>PPIND Engineering KPI Dashboard</h1>
                    <span class="org-badge">PayPay India</span>
                </div>
                <div class="header-meta">
                    <span class="last-updated" id="lastUpdated">Last updated: --</span>
                    <button class="refresh-btn" onclick="loadAllData()">â†» Refresh</button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="incidents">Incident / Defect Ratio</button>
            <button class="tab-btn" data-tab="tech-debts">Tech Debts</button>
            <button class="tab-btn" data-tab="cycle-time">Cycle Time</button>
            <button class="tab-btn" data-tab="lead-time">Lead Time</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Incidents Section -->
            <section id="incidents" class="tab-content active">
                <div class="section-header">
                    <h2>Incident / Defect Ratio</h2>
                    <p class="section-desc">Production incidents tracked by team with incident ratio (Incidents/Releases)</p>
                </div>

                <div class="data-table-container">
                    <table class="data-table kpi-table" id="incidentsTable">
                        <thead>
                            <tr>
                                <th rowspan="2">Team</th>
                                <th rowspan="2">EM</th>
                                <th colspan="3" class="quarter-header baseline">FY24 Q4 (Baseline)</th>
                                <th colspan="3" class="quarter-header">FY25 Q1</th>
                                <th colspan="4" class="quarter-header">FY25 Q2</th>
                            </tr>
                            <tr>
                                <th>Incidents</th>
                                <th>Releases</th>
                                <th>Ratio</th>
                                <th>Incidents</th>
                                <th>Releases</th>
                                <th>Ratio</th>
                                <th>Incidents</th>
                                <th>Releases</th>
                                <th>Ratio</th>
                                <th>Links</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td colspan="2"><strong>PayPay India</strong></td>
                                <td id="incidentTotalQ4Incidents">-</td>
                                <td id="incidentTotalQ4Releases">-</td>
                                <td id="incidentTotalQ4Ratio">-</td>
                                <td id="incidentTotalQ1Incidents">-</td>
                                <td id="incidentTotalQ1Releases">-</td>
                                <td id="incidentTotalQ1Ratio">-</td>
                                <td id="incidentTotalQ2Incidents">-</td>
                                <td id="incidentTotalQ2Releases">-</td>
                                <td id="incidentTotalQ2Ratio">-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="calculation-info">
                    <h4>ðŸ“Š How This is Calculated</h4>
                    <ul>
                        <li><strong>Incidents:</strong> Count of production incidents (IMA project tickets) attributed to each team during the quarter.</li>
                        <li><strong>Releases:</strong> Number of production releases/deployments by each team during the quarter.</li>
                        <li><strong>Incident Ratio:</strong> (Incidents Ã· Releases) Ã— 100. Lower is better. A ratio of 0% means no incidents.</li>
                        <li><strong>Color Coding:</strong> <span class="cell-green" style="padding:2px 6px;border-radius:4px;">Green</span> = ratio decreased or is 0%, <span class="cell-red" style="padding:2px 6px;border-radius:4px;">Red</span> = ratio increased vs baseline.</li>
                    </ul>
                </div>
            </section>

            <!-- Tech Debts Section -->
            <section id="tech-debts" class="tab-content">
                <div class="section-header">
                    <h2>PPIND FY25 Tech Debts</h2>
                    <p class="section-desc">Technical debt reduction tracking by quarter. Goal: â‰¥20% reduction per quarter.</p>
                </div>

                <div class="chart-container">
                    <canvas id="techDebtsChart"></canvas>
                </div>

                <div class="data-table-container">
                    <!-- Table generated dynamically by JavaScript -->
                </div>

                <div class="calculation-info">
                    <h4>ðŸ“Š How This is Calculated</h4>
                    <ul>
                        <li><strong>Start (Baseline):</strong> Count of open tech debt tickets in the team's epic on the first day of the quarter.</li>
                        <li><strong>Reduced:</strong> Number of tech debt tickets resolved (closed) during the quarter.</li>
                        <li><strong>% Reduction:</strong> (Reduced Ã· Start) Ã— 100. Higher is better.</li>
                        <li><strong>Goal:</strong> Each team should reduce at least 20% of their tech debt per quarter.</li>
                        <li><strong>Color Coding:</strong> <span class="cell-green" style="padding:2px 6px;border-radius:4px;">Green</span> = â‰¥20% reduction (goal met), <span class="cell-red" style="padding:2px 6px;border-radius:4px;">Red</span> = &lt;20% (below goal).</li>
                        <li><strong>WIP:</strong> Current quarter data is work-in-progress and updated weekly. Final numbers available after quarter ends.</li>
                    </ul>
                </div>
            </section>

            <!-- Cycle Time Section -->
            <section id="cycle-time" class="tab-content">
                <div class="section-header">
                    <h2>Cycle Time (P50)</h2>
                    <p class="section-desc">P50 (median) Cycle Time from first commit to production deployment, by team.</p>
                </div>

                <div class="chart-container">
                    <canvas id="cycleTimeChart"></canvas>
                </div>

                <div class="data-table-container">
                    <!-- Table generated dynamically by JavaScript -->
                </div>

                <div class="calculation-info">
                    <h4>ðŸ“Š How This is Calculated</h4>
                    <ul>
                        <li><strong>Cycle Time:</strong> Time from first commit on a branch to when that code is deployed to production. Measured for each PR merged.</li>
                        <li><strong>P50 (Median):</strong> The 50th percentile value. Half of all PRs have cycle time below this, half above. More stable than average.</li>
                        <li><strong>Baseline:</strong> Average of P50 cycle times for June, July, and August 2025. Used as reference point.</li>
                        <li><strong>Prev 3 Months Avg:</strong> Rolling average of the 3 months before the current month (e.g., for Dec: Sep + Oct + Nov average).</li>
                        <li><strong>Trend Arrows:</strong> â†‘ = cycle time increased (worse), â†“ = cycle time decreased (better).</li>
                        <li><strong>Color Coding:</strong> <span class="cell-green" style="padding:2px 6px;border-radius:4px;">Green</span> = faster than baseline, <span class="cell-red" style="padding:2px 6px;border-radius:4px;">Red</span> = slower than baseline.</li>
                        <li><strong>Data Source:</strong> LinearB API. Click team links to view detailed metrics in LinearB dashboard.</li>
                    </ul>
                </div>
            </section>

            <!-- Lead Time Section -->
            <section id="lead-time" class="tab-content">
                <div class="section-header">
                    <h2>Lead Time</h2>
                    <p class="section-desc">Epic lead time from PRD Start Date to Release Date (Done epics only)</p>
                </div>

                <!-- Scope Tabs: PayPay All, PPIND Only, PayPay excl. PPIND -->
                <nav class="scope-tabs" id="leadTimeScopeTabs">
                    <button class="scope-tab-btn" data-scope="paypay_all">PayPay All</button>
                    <button class="scope-tab-btn active" data-scope="ppind_only">PPIND Only</button>
                    <button class="scope-tab-btn" data-scope="excl_ppind">PayPay (excl. PPIND)</button>
                </nav>

                <div class="stats-grid" id="leadTimeStats">
                    <div class="stat-card">
                        <span class="stat-label">Avg Lead Time</span>
                        <span class="stat-value" id="avgLeadTime">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Median Lead Time</span>
                        <span class="stat-value" id="medianLeadTime">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Total Epics</span>
                        <span class="stat-value" id="totalEpics">--</span>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="leadTimeChart"></canvas>
                </div>

                <div class="data-table-container">
                    <h3>Epics by Quarter</h3>
                    
                    <!-- Quarter Sub-Tabs -->
                    <nav class="quarter-tabs" id="leadTimeQuarterTabs">
                        <!-- Tabs will be generated dynamically -->
                    </nav>
                    
                    <!-- Quarter Content -->
                    <div id="leadTimeQuarterContent">
                        <table class="data-table" id="leadTimeTable">
                            <thead>
                                <tr>
                                    <th>Epic</th>
                                    <th>Summary</th>
                                    <th>Status</th>
                                    <th>Lead Time (days)</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="calculation-info">
                    <h4>ðŸ“Š How Lead Time is Calculated</h4>
                    
                    <p><strong>Lead Time Formula:</strong> End Date âˆ’ Start Date (shown in days)</p>
                    
                    <h5>Start Date Logic:</h5>
                    <ul>
                        <li><strong>Primary:</strong> "PRD Start Date" field (customfield_15410) - when Product Requirements Document was started</li>
                        <li><strong>Fallback:</strong> If PRD Start Date is empty â†’ use Jira "Created Date"</li>
                    </ul>
                    
                    <h5>End Date Logic:</h5>
                    <ul>
                        <li><strong>Primary:</strong> "Release Date" field (customfield_10613) - when epic was released to production</li>
                        <li><strong>Fallback:</strong> If Release Date is empty â†’ use Jira "Resolved Date"</li>
                        <li><strong>Null Case:</strong> If BOTH Release Date and Resolved Date are empty â†’ Lead Time = null (epic excluded from calculations)</li>
                    </ul>
                    
                    <h5>Fiscal Year Quarter Assignment (with 10-day grace period):</h5>
                    <ul>
                        <li><strong>FY Quarters:</strong> Q1 = Apr-Jun, Q2 = Jul-Sep, Q3 = Oct-Dec, Q4 = Jan-Mar</li>
                        <li><strong>FY Naming:</strong> FY25 = April 2024 - March 2025</li>
                        <li>Epics are grouped by quarter based on the <strong>End Date</strong> (Release Date or Resolved Date)</li>
                        <li><strong>Grace Period:</strong> If End Date is within 10 calendar days after a quarter ends, the epic is still counted in that quarter</li>
                        <li>Example: Release Date = July 7, 2024 â†’ epic belongs to "FY25 Q1" (within 10 days of June 30)</li>
                        <li>Example: Release Date = July 15, 2024 â†’ epic belongs to "FY25 Q2" (beyond 10 days)</li>
                    </ul>
                    
                    <h5>Scope Filters:</h5>
                    <ul>
                        <li><strong>PPIND Only:</strong> Epics with "Tech Modules" field matching PPIND teams (16 modules)</li>
                        <li><strong>PayPay All:</strong> All PayPay project epics with PPIND Tech Modules</li>
                        <li><strong>PayPay (excl. PPIND):</strong> Epics that do NOT have PPIND Tech Modules</li>
                    </ul>
                    
                    <h5>Statistics:</h5>
                    <ul>
                        <li><strong>Avg Lead Time:</strong> Sum of all lead times Ã· number of epics with valid lead time. Affected by outliers.</li>
                        <li><strong>Median Lead Time:</strong> Middle value when sorted. More representative of typical epic.</li>
                        <li><strong>Total Epics:</strong> Count of epics with calculable lead time (excludes nulls)</li>
                    </ul>
                    
                    <h5>Data Source:</h5>
                    <ul>
                        <li>Jira project: PAYPAY</li>
                        <li>Issue type: Epic</li>
                        <li>Status: Done only</li>
                        <li>Date range: Resolved on or after July 1, 2024 (2024 Q3+)</li>
                    </ul>
                </div>
            </section>

        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>Data sourced from LinearB & Jira APIs â€¢ Updated weekly via GitHub Actions</p>
        </footer>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>Loading dashboard data...</p>
    </div>

    <script src="js/dashboard.js?v=20251211k"></script>
</body>
</html>
